<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/jpeg" href="https://i.ibb.co/jk6rHGjP/ramadan-kareem-logo-design-template-567288-457.jpg">
  <title>تطبيق القرآن ومواقيت الصلاة</title>
  <!-- الخطوط -->
  <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Emery&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Lateef&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Scheherazade+New&display=swap" rel="stylesheet">
  <!-- خط لقائمة التلاوة -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet">
  <!-- مكتبة الأيقونات و animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <!-- مكتبة confetti للتأثيرات -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <!-- مكتبة SweetAlert2 (CSS و JS) -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- تنسيقات لمسغل التلاوة -->
  <style>
    .audio-player {
      background: #ffffff;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
      margin: 20px;
    }
    .audio-player p {
      font-size: 18px;
      margin-bottom: 10px;
      color: var(--text-color);
    }
    .audio-player .controls {
      margin: 15px 0;
    }
    .audio-player .controls button {
      background: var(--gold-color);
      border: none;
      color: #fff;
      padding: 10px 15px;
      border-radius: 50%;
      margin: 0 10px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .audio-player .controls button:hover {
      background: #c59a32;
    }
    .audio-player .progress-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
    }
    .audio-player .progress-container input[type=range] {
      flex: 1;
      margin: 0 10px;
    }
  </style>
  <style>
    :root {
      --gold-color: #d4af37;
      --bg-color: #f8f9fa;
      --text-color: #333;
      --ayah-font-size: 24px;
      /* تقليل مدة الانتقال لتسريع الأداء */
      --transition-speed: 0.2s;
    }
    /* تحسين أداء الانيميشن بإضافة will-change للعناصر المتحركة */
    .section,
    .nav-item,
    .reciters-grid,
    .surah-item {
      will-change: transform, opacity;
    }
    /* الأنماط العامة لتطبيق القرآن ومواقيت الصلاة */
    body {
      background: var(--bg-color);
      color: var(--text-color);
      scroll-behavior: smooth;
      transition: background var(--transition-speed), color var(--transition-speed);
      text-shadow: 0 0 2px rgba(212,175,55,0.5);
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Amiri', serif;
      transition: transform var(--transition-speed), background var(--transition-speed), color var(--transition-speed);
    }
    /* شاشة التحميل */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg-color);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      transition: opacity 0.5s ease;
    }
    #loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .loader {
      text-align: center;
    }
    .spinner {
      width: 80px;
      height: 80px;
      border: 10px solid #f3f3f3;
      border-top: 10px solid var(--gold-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading-text {
      font-size: 1.2em;
      color: var(--gold-color);
    }
    /* تنسيقات الهيدر والقوائم */
    #header {
      position: fixed;
      top: 0;
      width: 100%;
      background: white;
      height: 60px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: top var(--transition-speed);
    }
    #logo {
      position: absolute;
      top: 10px;
      right: 20px;
      width: 50px;
      filter: brightness(0) saturate(100%) invert(77%) sepia(39%) saturate(376%) hue-rotate(7deg) brightness(105%) contrast(98%);
      z-index: 1001;
      pointer-events: none;
    }
    #hijri-date {
      position: absolute;
      top: 15px;
      left: 20px;
      background: white;
      padding: 6px 12px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 12px;
      color: var(--gold-color);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      z-index: 1001;
    }
    .container {
      padding: 100px 15px 80px;
      max-width: 400px;
      margin: 0 auto;
    }
    .section {
      display: none;
      animation: fadeIn var(--transition-speed) ease forwards;
    }
    .active-section {
      display: block;
    }
    /* شريط التنقل المصغر */
    .nav-bar {
      position: fixed;
      bottom: 0;
      width: 100%;
      max-width: 400px;
      height: 50px;
      background: #fff;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      border-radius: 20px 20px 0 0;
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;
    }
    .nav-item {
      text-align: center;
      color: #666;
      cursor: pointer;
      transition: transform var(--transition-speed), background var(--transition-speed);
      font-size: 10px;
      padding: 6px;
      border-radius: 10px;
      width: 25%;
    }
    .nav-item i {
      font-size: 16px;
      margin-bottom: 3px;
      display: block;
    }
    .nav-item.active {
      color: var(--gold-color);
      transform: translateY(-5px);
      background: rgba(212,175,55,0.1);
    }
    /* باقي التنسيقات كما هي دون تغيير */
    .reciters-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }
    .reciter-item {
      text-align: center;
      cursor: pointer;
      transition: transform 0.3s;
    }
    .reciter-item:hover {
      transform: scale(1.05);
    }
    .reciter-img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 50%;
      border: 4px solid var(--gold-color);
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
    }
    .reciter-name {
      margin-top: 8px;
      font-weight: bold;
    }
    .surah-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-family: 'Cairo', sans-serif;
      padding: 10px 20px;
      border-radius: 50px;
      background: rgba(255,255,255,0.2);
      box-shadow: 0 0 8px rgba(212,175,55,0.3);
      margin: 8px 0;
      cursor: pointer;
      transition: transform var(--transition-speed), box-shadow var(--transition-speed);
    }
    .surah-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 12px rgba(212,175,55,0.4);
    }
    .tilawah-surah-number {
      font-weight: bold;
      margin-right: 10px;
    }
    .tilawah-surah-name {
      flex-grow: 1;
      text-align: center;
    }
    .tilawah-surah-icon { }
    .surah-detail {
      background: #fff;
      border-radius: 15px;
      padding: 20px;
      margin: 20px auto;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      direction: rtl;
      text-align: justify;
      max-width: 350px;
      opacity: 0;
      animation: fadeIn var(--transition-speed) ease forwards;
    }
    .basmalah-image {
      display: block;
      max-width: 100%;
      height: auto;
    }
    .ayah-block {
      font-family: 'Emery', 'Lateef', 'Scheherazade New', 'Amiri', serif;
      font-size: var(--ayah-font-size);
      line-height: 2;
      text-align: justify;
      max-width: 350px;
      margin: 20px auto;
      opacity: 0;
      animation: fadeIn var(--transition-speed) ease forwards;
    }
    .ayah-number {
      display: inline-block;
      font-size: 16px;
      color: var(--gold-color);
      position: relative;
      padding: 0 4px;
    }
    .ayah-number::before {
      content: "﴿";
      color: var(--gold-color);
      margin-right: 2px;
    }
    .ayah-number::after {
      content: "﴾";
      color: var(--gold-color);
      margin-left: 2px;
    }
    .back-btn {
      background: var(--gold-color);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 25px;
      cursor: pointer;
      margin-bottom: 15px;
      display: block;
      width: 100%;
      text-align: center;
      transition: background var(--transition-speed);
    }
    .back-btn:hover {
      background: #c59a32;
    }
    /* تحسين قسم الصلاة (تم تعديله) */
    #prayer-section {
      background: linear-gradient(135deg, #fefefe, #f7f7f7);
      border-radius: 15px;
      padding: 25px;
      margin: 20px auto;
      max-width: 400px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .refresh-btn {
      background: var(--gold-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      margin-bottom: 20px;
      display: block;
      width: 100%;
      font-size: 1.1em;
      transition: background var(--transition-speed);
    }
    .refresh-btn:hover {
      opacity: 0.9;
    }
    .prayer-times-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 15px;
    }
    .prayer-time {
      text-align: center;
      padding: 25px;
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
      border: 1px solid #d4af37;
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
      font-size: 1.1em;
    }
    .prayer-time:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    #next-prayer-info {
      background: #fff;
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
      opacity: 0;
      animation: fadeIn var(--transition-speed) ease forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* تحسين قسم الصلاة للهاتف مع الحفاظ على باقي التنسيقات */
    @media (max-width: 480px) {
      .container {
        padding: 80px 10px 60px;
        max-width: 100%;
      }
      .nav-item {
        font-size: 10px;
        padding: 6px;
      }
      .nav-item i {
        font-size: 16px;
      }
      .ayah-block {
        font-size: var(--ayah-font-size);
      }
      #logo {
        width: 40px;
        top: 5px;
        right: 10px;
      }
      #prayer-section {
        padding: 15px;
        margin: 10px;
        max-width: 100%;
      }
      .prayer-time {
        padding: 20px;
        font-size: 1em;
      }
      .refresh-btn {
        padding: 10px;
        font-size: 1em;
      }
      .prayer-times-grid {
        gap: 10px;
      }
    }
    /* مؤشر إظهار شريط التنقل عند الإخفاء */
    #nav-toggle-indicator {
      display: none;
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1001;
      background: var(--gold-color);
      padding: 5px 10px;
      border-radius: 20px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s;
    }
    #nav-toggle-indicator i {
      font-size: 16px;
      color: #fff;
    }
  </style>
</head>
<body>
  <!-- شاشة تحميل البيانات -->
  <div id="loading-overlay">
    <div class="loader">
      <div class="spinner"></div>
      <p class="loading-text">جارٍ التحميل...</p>
    </div>
  </div>
  <div id="header">
    <img id="logo" src="https://equran.me/assets/-images/logo-x.png" alt="logo">
    <div id="hijri-date">جاري التحميل...</div>
  </div>
  <div class="container">
    <!-- قسم القرآن الكريم -->
    <div id="quran-section" class="section active-section">
      <div id="surah-menu"></div>
      <div id="surah-content"></div>
    </div>
    <!-- قسم الصلاة -->
    <div id="prayer-section" class="section">
      <button onclick="showPrayerTimes()" class="refresh-btn">تحديث مواقيت الصلاة</button>
      <div id="prayer-container"></div>
      <div id="next-prayer-info"></div>
    </div>
    <!-- قسم التلاوة -->
    <div id="tilaawa-section" class="section">
      <div id="reciters-container" class="reciters-grid">
        <div class="reciter-item" onclick="selectReciter('minshawi')">
          <img src="https://i.ibb.co/4ZS6bvPZ/IMG.png" alt="محمد صديق المنشاوي" class="reciter-img">
          <p class="reciter-name">محمد صديق المنشاوي</p>
        </div>
        <div class="reciter-item" onclick="selectReciter('basit')">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRXQk0uLqCA45lr_ws9XFuaRP5Igmz5sKnHxQ" alt="عبد الباسط" class="reciter-img">
          <p class="reciter-name">عبد الباسط</p>
        </div>
        <div class="reciter-item" onclick="selectReciter('yasser')">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQHznlZh1YOJk3hUxxZ03wyR366ZvleyypWOg&s" alt="ياسر الدوسري" class="reciter-img">
          <p class="reciter-name">ياسر الدوسري</p>
        </div>
        <div class="reciter-item" onclick="selectReciter('maher')">
          <img src="https://i.pinimg.com/564x/ab/cc/99/abcc9949d0419ef1f0963a54aef06397.jpg" alt="ماهر المعيقلي" class="reciter-img">
          <p class="reciter-name">ماهر المعيقلي</p>
        </div>
        <div class="reciter-item" onclick="selectReciter('mustafa')">
          <img src="https://i.pinimg.com/564x/41/e5/5e/41e55ea6e5e5d70798320e94d447cdb7.jpg" alt="مصطفى إسماعيل" class="reciter-img">
          <p class="reciter-name">مصطفى إسماعيل</p>
        </div>
        <div class="reciter-item" onclick="selectReciter('husari')">
          <img src="https://i.pinimg.com/564x/3f/da/7e/3fda7ed5056347e700cac64d07e164c3.jpg" alt="الحصري" class="reciter-img">
          <p class="reciter-name">الحصري</p>
        </div>
      </div>
      <div id="surah-list" style="display: none; margin-top: 20px;"></div>
      <div id="tilaawa-detail" style="display: none;"></div>
    </div>
    <!-- قسم الخاتمة -->
    <div id="khatma-section" class="section">
      <!-- دمج كود الخاتمة مباشرة دون علامات خارجية -->
      <div id="conclusion-content">
        <style>
          /* أنماط قسم الخاتمة مع عزلها باستخدام المعرف */
          :root {
            --primary-color: #d4af37;
            --secondary-color: #b8860b;
            --background-color: #faf8f5;
            --text-color: #5a4a42;
            --completed-color: #4CAF50;
            --in-progress-color: #FFEB3B;
            --not-started-color: #FF5252;
            --locked-color: #9E9E9E;
          }
          #conclusion-content * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
          }
          #conclusion-content {
            font-family: 'Lateef', serif;
            font-size: 1.5em;
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 10px;
            animation: gradientShift 20s infinite alternate;
          }
          @keyframes gradientShift {
            0% { background-color: #faf8f5; }
            50% { background-color: #fff5e6; }
            100% { background-color: #faf8f5; }
          }
          /* باقي الأنماط كما في كود الخاتمة الأصلي */
          #conclusion-content #juz-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            padding: 5px;
            margin: 10px 0;
          }
          #conclusion-content .juz-item {
            padding: 15px;
            border: 2px solid transparent;
            border-radius: 30px;
            background: linear-gradient(145deg, #ffffff, #fff5e6);
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
          }
          #conclusion-content .juz-item::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.3) 50%, transparent 60%);
            animation: juzShine 3s infinite;
          }
          @keyframes juzShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
          }
          #conclusion-content .juz-item:hover {
            transform: translateY(-5px) rotate(2deg);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
          }
          #conclusion-content .juz-item.completed { 
            background: linear-gradient(145deg, #4CAF50, #45a049);
            animation: successPulse 1.5s infinite;
          }
          @keyframes successPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
          }
          #conclusion-content .juz-item.in-progress { 
            background: linear-gradient(145deg, #FFEB3B, #fdd835);
            animation: progressGlow 1.5s infinite alternate;
          }
          @keyframes progressGlow {
            from { box-shadow: 0 0 10px rgba(255, 235, 59, 0.3); }
            to { box-shadow: 0 0 20px rgba(255, 235, 59, 0.6); }
          }
          #conclusion-content #ayahs-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(250, 248, 245, 0.95);
            padding: 15px;
            z-index: 1000;
            animation: modalEntrance 0.5s cubic-bezier(0.4, 0, 0.2, 1);
          }
          @keyframes modalEntrance {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
          }
          /* تكبير حجم حاوية الآيات في الخاتمة */
          #conclusion-content #ayahs-content {
            font-size: 1.8rem;
            line-height: 2.2;
            height: 90vh;
            width: 100%;
            margin: 0 auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 15px;
            text-align: justify;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
          }
          #conclusion-content .ayah-number {
            color: var(--primary-color);
            font-weight: bold;
            display: inline-block;
            margin: 0 5px;
          }
          #conclusion-content #complete-ayahs-button {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            padding: 12px;
            margin: 10px 0;
            font-size: 1.2rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: #fff;
            border-radius: 30px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 2000;
            animation: buttonGlow 1.5s infinite alternate;
          }
          @keyframes buttonGlow {
            from { box-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }
            to { box-shadow: 0 0 20px rgba(212, 175, 55, 0.6); }
          }
          #conclusion-content #logout-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 12px 20px;
            font-size: 1.1rem;
            z-index: 100;
            border-radius: 30px;
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            color: white;
            border: none;
            cursor: pointer;
          }
        </style>
        <!-- محتوى الخاتمة من الكود الأصلي -->
        <div id="juz-list"></div>
        <div id="ayahs-container">
          <div id="ayahs-content"></div>
          <button id="complete-ayahs-button" class="complete-button">
            <i class="fas fa-check"></i> تمت القراءة
          </button>
        </div>
        <button id="logout-button">
          <i class="fas fa-sign-out-alt"></i> خروج
        </button>
        <!-- استيراد المكتبات المطلوبة داخل قسم الخاتمة -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
        <script>
          // إعدادات Firebase الخاصة بقسم الخاتمة
          const firebaseConfig = {
            apiKey: "AIzaSyAI6nX4cuEoD-IH3Tkgl3V9han--jq5AmM",
            authDomain: "conclusion-2-4de05.firebaseapp.com",
            databaseURL: "https://conclusion-2-4de05-default-rtdb.firebaseio.com",
            projectId: "conclusion-2-4de05",
            storageBucket: "conclusion-2-4de05.firebasestorage.app",
            messagingSenderId: "846069593492",
            appId: "1:846069593492:web:ba5f0d8c233cc8a8524b81",
            measurementId: "G-2TT32CNW51"
          };
          firebase.initializeApp(firebaseConfig);
          const database = firebase.database();
          const userId = `user-${Math.random().toString(36).substr(2, 9)}`;
          let currentJuzNumber = null;
          let userName = localStorage.getItem('userName') || '';
          function initApp() {
            if (!userName) showNamePrompt();
            else showWelcome();
            setupEventListeners();
            renderJuzList();
            checkSavedJuz();
          }
          function showNamePrompt() {
            Swal.fire({
              title: 'أدخل اسمك الكريم',
              input: 'text',
              inputAttributes: { autocapitalize: 'words' },
              confirmButtonText: 'تأكيد',
              allowOutsideClick: false,
              preConfirm: (name) => {
                if (!name.trim()) {
                  Swal.showValidationMessage('الاسم مطلوب');
                  return false;
                }
                return name;
              }
            }).then((result) => {
              if (result.isConfirmed) {
                userName = result.value;
                localStorage.setItem('userName', userName);
                showWelcome();
              }
            });
          }
          function showWelcome() {
            Swal.fire({
              toast: true,
              position: 'center',
              icon: 'success',
              title: `مرحباً ${userName}`,
              showConfirmButton: false,
              timer: 3000,
              timerProgressBar: true,
              customClass: {
                popup: 'animated dropExpand capsule-toast'
              }
            });
          }
          function renderJuzList() {
            database.ref('juz').on('value', (snapshot) => {
              const juzData = snapshot.val() || {};
              document.getElementById('juz-list').innerHTML = Array.from({ length: 30 }, (_, i) => {
                const juzNum = i + 1;
                const juz = juzData[juzNum] || {};
                const isLocked = juz.isLocked && juz.lockedBy !== userId;
                return `
                  <div class="juz-item ${juz.status || 'not-started'} ${isLocked ? 'locked' : ''}" 
                       data-juz="${juzNum}" 
                       onclick="${!isLocked ? `handleJuzClick(${juzNum})` : ''}">
                    <i class="fas fa-book-open"></i>
                    <span>الجزء ${juzNum}</span>
                    ${isLocked ? `<small>القارئ: ${juz.readerName}</small>` : ''}
                  </div>
                `;
              }).join('');
            });
          }
          function handleJuzClick(juzNum) {
            if (currentJuzNumber && currentJuzNumber !== juzNum) {
              Swal.fire({
                toast: true,
                position: 'center',
                icon: 'warning',
                title: 'الجزء الحالي',
                text: 'يجب إنهاء الجزء الحالي أولاً',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                customClass: {
                  popup: 'animated dropExpand capsule-toast'
                }
              });
              return;
            }
            database.ref(`juz/${juzNum}`).once('value').then(snapshot => {
              const juz = snapshot.val() || {};
              if (juz.status === 'completed') {
                Swal.fire({
                  toast: true,
                  position: 'center',
                  icon: 'info',
                  title: 'جزء مكتمل',
                  text: 'هذا الجزء منتهي بالفعل',
                  showConfirmButton: false,
                  timer: 3000,
                  timerProgressBar: true,
                  customClass: {
                    popup: 'animated dropExpand capsule-toast'
                  }
                });
              } else {
                lockJuz(juzNum);
              }
            });
          }
          function lockJuz(juzNum) {
            database.ref(`juz/${juzNum}`).set({
              status: 'in-progress',
              lockedBy: userId,
              isLocked: true,
              readerName: userName,
              startTime: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
              currentJuzNumber = juzNum;
              localStorage.setItem('currentJuz', juzNum);
              loadAyahs(juzNum);
              Swal.fire({
                toast: true,
                position: 'center',
                icon: 'success',
                title: 'بداية موفقة',
                text: `بدأت قراءة الجزء ${juzNum}`,
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                customClass: {
                  popup: 'animated dropExpand capsule-toast'
                }
              });
            });
          }
          function loadAyahs(juzNum) {
            document.getElementById('juz-list').style.display = 'none';
            document.getElementById('ayahs-container').style.display = 'block';
            const completeButton = document.getElementById('complete-ayahs-button');
            completeButton.style.display = 'none';
            fetch(`https://api.alquran.cloud/v1/juz/${juzNum}/ar.alafasy`)
              .then(response => response.json())
              .then(data => {
                // عرض رقم الآية بين رمز واحد من ﴿ و﴾ فقط
                const ayahs = data.data.ayahs
                  .map(ayah => `<span class="ayah-number">﴿${ayah.numberInSurah}﴾</span>${ayah.text}`)
                  .join(' ');
                document.getElementById('ayahs-content').innerHTML = ayahs;
                const ayahsContent = document.getElementById('ayahs-content');
                const savedAyah = localStorage.getItem(`currentAyah_${juzNum}`);
                if (savedAyah) {
                  const ayahElement = Array.from(ayahsContent.querySelectorAll('.ayah-number'))
                    .find(ayah => ayah.textContent.includes(savedAyah));
                  if (ayahElement) {
                    ayahsContent.scrollTop = ayahElement.offsetTop;
                  }
                }
                ayahsContent.addEventListener('scroll', () => {
                  const visibleAyahs = Array.from(ayahsContent.querySelectorAll('.ayah-number'))
                    .filter(ayah => ayah.getBoundingClientRect().top >= 0 && ayah.getBoundingClientRect().bottom <= ayahsContent.clientHeight);
                  if (visibleAyahs.length > 0) {
                    localStorage.setItem(`currentAyah_${juzNum}`, visibleAyahs[0].textContent.replace(/[^0-9]/g, ''));
                  }
                });
                function checkScroll() {
                  const isBottom = ayahsContent.scrollHeight - ayahsContent.scrollTop <= ayahsContent.clientHeight + 50;
                  if (isBottom) {
                    completeButton.style.display = 'block';
                    ayahsContent.removeEventListener('scroll', checkScroll);
                  }
                }
                checkScroll();
                if (ayahsContent.scrollHeight > ayahsContent.clientHeight) {
                  ayahsContent.addEventListener('scroll', checkScroll);
                } else {
                  completeButton.style.display = 'block';
                }
              })
              .catch(() => Swal.fire({
                icon: 'error',
                title: 'خطأ',
                text: 'تعذر تحميل الآيات',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                customClass: {
                  popup: 'animated dropExpand capsule-toast'
                }
              }));
          }
          function completeJuz() {
            if (!currentJuzNumber) return;
            database.ref(`juz/${currentJuzNumber}`).update({
              status: 'completed',
              isLocked: true,
              lockedBy: null,
              readerName: '',
              endTime: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
              currentJuzNumber = null;
              localStorage.removeItem('currentJuz');
              document.getElementById('ayahs-container').style.display = 'none';
              document.getElementById('juz-list').style.display = 'grid';
              Swal.fire({
                toast: true,
                position: 'center',
                icon: 'success',
                title: 'مبروك!',
                text: 'تم إكمال الجزء بنجاح',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                customClass: {
                  popup: 'animated dropExpand capsule-toast'
                }
              });
            });
          }
          function checkSavedJuz() {
            const savedJuz = localStorage.getItem('currentJuz');
            if (savedJuz) {
              currentJuzNumber = savedJuz;
              loadAyahs(savedJuz);
            }
          }
          function setupEventListeners() {
            document.getElementById('complete-ayahs-button').addEventListener('click', () => {
              Swal.fire({
                title: 'تأكيد الإنهاء',
                text: 'هل أنت متأكد من إكمال هذا الجزء؟',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'نعم',
                cancelButtonText: 'لا'
              }).then((result) => {
                if (result.isConfirmed) completeJuz();
              });
            });
            document.getElementById('logout-button').addEventListener('click', () => {
              localStorage.clear();
              Swal.fire({
                toast: true,
                position: 'center',
                icon: 'info',
                title: 'تم الخروج',
                text: 'إلى لقاء قريب بإذن الله',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                customClass: {
                  popup: 'animated dropExpand capsule-toast'
                }
              }).then(() => location.reload());
            });
          }
          initApp();
        </script>
      </div>
    </div>
  </div>
  <!-- شريط التنقل المصغر -->
  <div class="nav-bar">
    <div class="nav-item active" onclick="showSection('quran-section', this)">
      <i class="fas fa-quran"></i>
      القرآن
    </div>
    <div class="nav-item" onclick="showSection('prayer-section', this)">
      <i class="fas fa-clock"></i>
      الصلاة
    </div>
    <div class="nav-item" onclick="showSection('tilaawa-section', this)">
      <i class="fas fa-music"></i>
      التلاوة
    </div>
    <div class="nav-item" onclick="showSection('khatma-section', this)">
      <i class="fas fa-users"></i>
      الخاتمة
    </div>
  </div>
  <!-- مؤشر إعادة إظهار شريط التنقل (يظهر عند إخفاء الشريط) -->
  <div id="nav-toggle-indicator">
    <i class="fas fa-chevron-up"></i>
  </div>
  <!-- سكريبتات الأقسام المشتركة -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      if (audioContext.state === 'suspended') {
        fetch('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA')
          .then(response => response.arrayBuffer())
          .then(buffer => audioContext.decodeAudioData(buffer))
          .then(decodedData => {
            const source = audioContext.createBufferSource();
            source.buffer = decodedData;
            source.connect(audioContext.destination);
            source.start(0);
            audioContext.resume();
          })
          .catch(e => console.log("AudioContext unlocking failed: ", e));
      }
      function unlockAudio() {
         const silentAudio = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=");
         silentAudio.play().catch(e => { console.log("Audio unlock failed: ", e); });
         document.removeEventListener('click', unlockAudio);
         document.removeEventListener('touchstart', unlockAudio);
      }
      document.addEventListener('click', unlockAudio, {once: true});
      document.addEventListener('touchstart', unlockAudio, {once: true});
      (function() {
        const navBar = document.querySelector('.nav-bar');
        const navToggleIndicator = document.getElementById('nav-toggle-indicator');
        let touchStartY = 0;
        let longPressTimeout = null;
        const longPressDuration = 600;
        const dragThreshold = 30;
        if(navBar && navToggleIndicator) {
          navBar.addEventListener('touchstart', function(e) {
            touchStartY = e.touches[0].clientY;
            longPressTimeout = setTimeout(() => {}, longPressDuration);
          });
          navBar.addEventListener('touchmove', function(e) {
            const currentY = e.touches[0].clientY;
            const deltaY = currentY - touchStartY;
            if (longPressTimeout && deltaY > dragThreshold) {
              clearTimeout(longPressTimeout);
              longPressTimeout = null;
              navBar.classList.add('animate__animated', 'animate__fadeOutDown');
              setTimeout(() => {
                navBar.style.display = 'none';
                navBar.classList.remove('animate__animated', 'animate__fadeOutDown');
                navToggleIndicator.style.display = 'block';
                setTimeout(() => { navToggleIndicator.style.opacity = 1; }, 10);
              }, 200);
            }
          });
          navBar.addEventListener('touchend', function(e) {
            if (longPressTimeout) {
              clearTimeout(longPressTimeout);
              longPressTimeout = null;
            }
          });
          navToggleIndicator.addEventListener('click', function() {
            navToggleIndicator.style.opacity = 0;
            setTimeout(() => {
              navToggleIndicator.style.display = 'none';
              navBar.style.display = 'flex';
              navBar.classList.add('animate__animated', 'animate__fadeInUp');
              setTimeout(() => {
                navBar.classList.remove('animate__animated', 'animate__fadeInUp');
              }, 200);
            }, 300);
          });
        }
      })();
    });
    
    window.adhanAudios = {
      Fajr: new Audio("https://ia800908.us.archive.org/12/items/90---azan---90---azan--many----sound----mp3---alazan/033--.mp3"),
      Dhuhr: new Audio("https://ia800908.us.archive.org/12/items/90---azan---90---azan--many----sound----mp3---alazan/048-.mp3"),
      Asr: new Audio("https://ia800908.us.archive.org/12/items/90---azan---90---azan--many----sound----mp3---alazan/020--2.mp3"),
      Maghrib: new Audio("https://ia800908.us.archive.org/12/items/90---azan---90---azan--many----sound----mp3---alazan/042--.mp3"),
      Isha: new Audio("https://ia800908.us.archive.org/12/items/90---azan---90---azan--many----sound----mp3---alazan/019--1.mp3")
    };
    for (let prayer in window.adhanAudios) {
      window.adhanAudios[prayer].load();
    }
    const CORS_PROXY = "https://api.allorigins.win/raw?url=";
    async function fetchData(url) {
      try {
        const response = await fetch(CORS_PROXY + encodeURIComponent(url));
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('فشل في جلب البيانات', error);
        hideLoadingOverlay();
        return null;
      }
    }
    async function updateHijriDate() {
      const today = new Date();
      const url = `https://api.aladhan.com/v1/gToH/${today.getDate()}-${today.getMonth()+1}-${today.getFullYear()}`;
      const data = await fetchData(url);
      if(data?.data?.hijri) {
        const hijri = data.data.hijri;
        document.getElementById('hijri-date').innerHTML = `${hijri.day} ${hijri.month.ar} ${hijri.year} هـ`;
      }
    }
    async function showSurahMenu() {
      showLoadingOverlay();
      const data = await fetchData("http://api.alquran.cloud/v1/surah");
      if(data?.data) {
        document.getElementById('surah-menu').innerHTML = data.data
          .map(surah =>
            `<div class="surah-item animate__animated animate__fadeIn" onclick="showSurahVerses(${surah.number})">
              <span class="tilawah-surah-number">${surah.number}</span>
              <span class="tilawah-surah-name">${surah.name}</span>
              <span class="tilawah-surah-icon"><i class="fas fa-quran"></i></span>
            </div>`
          )
          .join('');
      }
      hideLoadingOverlay();
    }
    async function showSurahVerses(surahNumber) {
      showLoadingOverlay();
      const data = await fetchData(`http://api.alquran.cloud/v1/surah/${surahNumber}`);
      if(data?.data) {
        const surah = data.data;
        let ayahs = surah.ayahs;
        let headerHTML = "";
        if (surahNumber != 9) {
          if (ayahs.length && ayahs[0].text.includes("اللَّهِ")) {
            ayahs = ayahs.slice(1);
          }
          headerHTML = `<img src="https://surahquran.com/img/basmalah.png" alt="بسم الله الرحمن الرحيم" class="basmalah-image">`;
        } else {
          headerHTML = `<img src="https://surahquran.com/img/basmalah.png" alt="استعاذة" class="basmalah-image">`;
        }
        document.getElementById('surah-menu').style.display = 'none';
        document.getElementById('surah-content').innerHTML = `
          <button class="back-btn" onclick="backToSurahMenuFromQuran()">
            <i class="fas fa-arrow-left"></i> العودة لقائمة السور
          </button>
          <div class="surah-detail">
            ${headerHTML}
            <p class="ayah-block">${ayahs.map(ayah => `${ayah.text}<sup class="ayah-number"><span>${ayah.numberInSurah}</span></sup>`).join('')}</p>
          </div>`;
      }
      hideLoadingOverlay();
    }
    function backToSurahMenuFromQuran() {
      document.getElementById('surah-menu').style.display = 'block';
      document.getElementById('surah-content').innerHTML = '';
      showSurahMenu();
    }
    async function fetchPrayerTimesGlobal() {
      const today = new Date();
      const day = String(today.getDate()).padStart(2, '0');
      const month = String(today.getMonth()+1).padStart(2, '0');
      const year = today.getFullYear();
      const url = `https://api.aladhan.com/v1/timingsByCity/${day}-${month}-${year}?city=Cairo&country=Egypt&method=8`;
      const data = await fetchData(url);
      if(data?.data?.timings) {
        window.globalPrayerTimes = data.data.timings;
      }
    }
    function updateCountdown(prayerTimes) {
      const { nextPrayerName, nextPrayerTime } = getNextPrayer(prayerTimes);
      const now = new Date();
      let diffMs = nextPrayerTime - now;
      if(diffMs < 0) diffMs += 86400000;
      const diffSeconds = Math.floor(diffMs / 1000);
      const hrs = Math.floor(diffSeconds / 3600);
      const mins = Math.floor((diffSeconds % 3600) / 60);
      const secs = diffSeconds % 60;
      const nextPrayerInfoElem = document.getElementById('next-prayer-info');
      if(nextPrayerInfoElem) {
        nextPrayerInfoElem.innerHTML = `
          <h3>الصلاة القادمة: ${prayerNameArabic[nextPrayerName]}</h3>
          <p>الوقت المتبقي: ${hrs} س ${mins} د ${secs} ث</p>`;
      }
      if(diffSeconds > 300) {
         window.preAdhanTriggered = false;
      }
      if(diffSeconds <= 300 && diffSeconds > 0 && !window.preAdhanTriggered){
          window.preAdhanTriggered = true;
          Swal.fire({
              toast: true,
              position: 'top-end',
              icon: 'info',
              title: `تنبيه: موعد الصلاة يقترب (${prayerNameArabic[nextPrayerName]})`,
              showConfirmButton: false,
              timer: 3000,
              timerProgressBar: true,
              customClass: { popup: 'animate__animated animate__fadeInDown' }
          });
      }
      if(window.lastPrayerName !== nextPrayerName) {
         window.adhanTriggered = false;
         window.lastPrayerName = nextPrayerName;
      }
      if (diffSeconds <= 0 && !window.adhanTriggered) {
        window.adhanTriggered = true;
        playAdhan(nextPrayerName);
      }
    }
    function getNextPrayer(prayerTimes) {
      const now = new Date();
      let nextPrayerName = "";
      let nextPrayerTime = null;
      const prayerOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
      for (const prayer of prayerOrder) {
        const [hours, minutes] = prayerTimes[prayer].split(':').map(Number);
        const prayerDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
        if (prayerDate > now) {
          nextPrayerName = prayer;
          nextPrayerTime = prayerDate;
          break;
        }
      }
      if (!nextPrayerTime) {
        const [hours, minutes] = prayerTimes.Fajr.split(':').map(Number);
        nextPrayerTime = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, hours, minutes);
        nextPrayerName = "Fajr";
      }
      return { nextPrayerName, nextPrayerTime };
    }
    const prayerNameArabic = { 
      Fajr: 'الفجر', 
      Sunrise: 'الشروق', 
      Dhuhr: 'الظهر', 
      Asr: 'العصر', 
      Maghrib: 'المغرب', 
      Isha: 'العشاء' 
    };
    const prayerIcons = { 
      Fajr: "fas fa-moon", 
      Sunrise: "fas fa-sun", 
      Dhuhr: "fas fa-sun", 
      Asr: "fas fa-cloud-sun", 
      Maghrib: "fas fa-moon", 
      Isha: "fas fa-pray" 
    };
    function playAdhan(prayerName) {
      const arabicName = prayerNameArabic[prayerName] || prayerName;
      confetti({ particleCount: 100, spread: 70 });
      const audio = window.adhanAudios[prayerName];
      if (audio) {
        audio.muted = true;
        audio.play().then(() => {
          audio.muted = false;
        }).catch(err => console.log("Audio autoplay prevented: ", err));
      }
      Swal.fire({
        title: '<strong style="color: var(--gold-color); font-size: 24px;">حان وقت الأذان</strong>',
        html: `<div style="font-size: 20px; padding: 10px 15px; border: 2px solid var(--gold-color); border-radius: 10px; background: #fff; display: inline-block;">أذان: ${arabicName}</div>`,
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        customClass: { popup: 'animate__animated animate__zoomIn' },
        backdrop: `rgba(0,0,0,0.7)`
      });
      setTimeout(() => { window.adhanTriggered = false; }, 1000);
    }
    function selectReciter(reciter) {
      window.currentReciter = reciter;
      document.getElementById('reciters-container').style.display = 'none';
      document.getElementById('surah-list').style.display = 'block';
      loadTilaawaSurahs();
    }
    function loadTilaawaSurahs() {
      const surahs = [
        { name: "الفاتحة", number: "001" },
        { name: "البقرة", number: "002" },
        { name: "آل عمران", number: "003" },
        { name: "النساء", number: "004" },
        { name: "المائدة", number: "005" },
        { name: "الأنعام", number: "006" },
        { name: "الأعراف", number: "007" },
        { name: "الأنفال", number: "008" },
        { name: "التوبة", number: "009" },
        { name: "يونس", number: "010" },
        { name: "هود", number: "011" },
        { name: "يوسف", number: "012" },
        { name: "الرعد", number: "013" },
        { name: "إبراهيم", number: "014" },
        { name: "الحجر", number: "015" },
        { name: "النحل", number: "016" },
        { name: "الإسراء", number: "017" },
        { name: "الكهف", number: "018" },
        { name: "مريم", number: "019" },
        { name: "طه", number: "020" },
        { name: "الأنبياء", number: "021" },
        { name: "الحج", number: "022" },
        { name: "المؤمنون", number: "023" },
        { name: "النور", number: "024" },
        { name: "الفرقان", number: "025" },
        { name: "الشعراء", number: "026" },
        { name: "النمل", number: "027" },
        { name: "القصص", number: "028" },
        { name: "العنكبوت", number: "029" },
        { name: "الروم", number: "030" },
        { name: "لقمان", number: "031" },
        { name: "السجدة", number: "032" },
        { name: "الأحزاب", number: "033" },
        { name: "سبأ", number: "034" },
        { name: "فاطر", number: "035" },
        { name: "يس", number: "036" },
        { name: "الصافات", number: "037" },
        { name: "ص", number: "038" },
        { name: "الزمر", number: "039" },
        { name: "غافر", number: "040" },
        { name: "فصلت", number: "041" },
        { name: "الشورى", number: "042" },
        { name: "الزخرف", number: "043" },
        { name: "الدخان", number: "044" },
        { name: "الجاثية", number: "045" },
        { name: "الأحقاف", number: "046" },
        { name: "محمد", number: "047" },
        { name: "الفتح", number: "048" },
        { name: "الحجرات", number: "049" },
        { name: "ق", number: "050" },
        { name: "الذاريات", number: "051" },
        { name: "الطور", number: "052" },
        { name: "النجم", number: "053" },
        { name: "القمر", number: "054" },
        { name: "الرحمن", number: "055" },
        { name: "الواقعة", number: "056" },
        { name: "الحديد", number: "057" },
        { name: "المجادلة", number: "058" },
        { name: "الحشر", number: "059" },
        { name: "الممتحنة", number: "060" },
        { name: "الصف", number: "061" },
        { name: "الجمعة", number: "062" },
        { name: "المنافقون", number: "063" },
        { name: "التغابن", number: "064" },
        { name: "الطلاق", number: "065" },
        { name: "التحريم", number: "066" },
        { name: "الملك", number: "067" },
        { name: "القلم", number: "068" },
        { name: "الحاقة", number: "069" },
        { name: "المعارج", number: "070" },
        { name: "نوح", number: "071" },
        { name: "الجن", number: "072" },
        { name: "المزمل", number: "073" },
        { name: "المدثر", number: "074" },
        { name: "القيامة", number: "075" },
        { name: "الإنسان", number: "076" },
        { name: "المرسلات", number: "077" },
        { name: "النبأ", number: "078" },
        { name: "النازعات", number: "079" },
        { name: "عبس", number: "080" },
        { name: "التكوير", number: "081" },
        { name: "الانفطار", number: "082" },
        { name: "المطففين", number: "083" },
        { name: "الانشقاق", number: "084" },
        { name: "البروج", number: "085" },
        { name: "الطارق", number: "086" },
        { name: "الأعلى", number: "087" },
        { name: "الغاشية", number: "088" },
        { name: "الفجر", number: "089" },
        { name: "البلد", number: "090" },
        { name: "الشمس", number: "091" },
        { name: "الليل", number: "092" },
        { name: "الضحى", number: "093" },
        { name: "الشرح", number: "094" },
        { name: "التين", number: "095" },
        { name: "العلق", number: "096" },
        { name: "القدر", number: "097" },
        { name: "البينة", number: "098" },
        { name: "الزلزلة", number: "099" },
        { name: "العاديات", number: "100" },
        { name: "القارعة", number: "101" },
        { name: "التكاثر", number: "102" },
        { name: "العصر", number: "103" },
        { name: "الهمزة", number: "104" },
        { name: "الفيل", number: "105" },
        { name: "قريش", number: "106" },
        { name: "الماعون", number: "107" },
        { name: "الكوثر", number: "108" },
        { name: "الكافرون", number: "109" },
        { name: "النصر", number: "110" },
        { name: "المسد", number: "111" },
        { name: "الإخلاص", number: "112" },
        { name: "الفلق", number: "113" },
        { name: "الناس", number: "114" }
      ];
      surahs.sort((a, b) => parseInt(a.number) - parseInt(b.number));
      window.globalSurahList = surahs;
      const surahList = document.getElementById('surah-list');
      surahList.innerHTML = surahs.map(surah => {
        return `
          <div class="surah-item animate__animated animate__fadeIn" onclick="playTilaawa(${parseInt(surah.number,10)})">
            <span class="tilawah-surah-number">${surah.number}</span>
            <span class="tilawah-surah-name">سورة ${surah.name}</span>
            <span class="tilawah-surah-icon"><i class="fas fa-microphone"></i></span>
          </div>
        `;
      }).join('');
    }
    function playTilaawa(surahNumber) {
      document.getElementById('surah-list').style.display = 'none';
      const tilaawaDetail = document.getElementById('tilaawa-detail');
      tilaawaDetail.style.display = 'block';
      const surahIndex = window.globalSurahList.findIndex(s => parseInt(s.number) === parseInt(surahNumber));
      window.currentSurahIndex = surahIndex !== -1 ? surahIndex : 0;
      loadTilawah(window.globalSurahList[window.currentSurahIndex]);
      window.scrollTo(0, 0);
    }
    function loadTilawah(surah) {
      const tilaawaDetail = document.getElementById('tilaawa-detail');
      const num = parseInt(surah.number, 10);
      const paddedNumber = String(num).padStart(3, '0');
      let audioSrc = "";
      if(window.currentReciter === 'minshawi') {
        audioSrc = `https://server10.mp3quran.net/minsh/${paddedNumber}.mp3`;
      } else if(window.currentReciter === 'basit') {
        audioSrc = `https://server7.mp3quran.net/basit/${paddedNumber}.mp3`;
      } else if(window.currentReciter === 'yasser') {
        audioSrc = `https://server11.mp3quran.net/yasser/${paddedNumber}.mp3`;
      } else if(window.currentReciter === 'maher') {
        audioSrc = `https://server12.mp3quran.net/maher/${paddedNumber}.mp3`;
      } else if(window.currentReciter === 'mustafa') {
        audioSrc = `https://server8.mp3quran.net/mustafa/${paddedNumber}.mp3`;
      } else if(window.currentReciter === 'husari') {
        audioSrc = `https://server13.mp3quran.net/husr/${paddedNumber}.mp3`;
      }
      let reciterImg = "";
      if(window.currentReciter === 'minshawi'){
        reciterImg = "https://i.ibb.co/4ZS6bvPZ/IMG.png";
      } else if(window.currentReciter === 'basit'){
        reciterImg = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRXQk0uLqCA45lr_ws9XFuaRP5Igmz5sKnHxQ";
      } else if(window.currentReciter === 'yasser'){
        reciterImg = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQHznlZh1YOJk3hUxxZ03wyR366ZvleyypWOg&s";
      } else if(window.currentReciter === 'maher'){
        reciterImg = "https://i.pinimg.com/564x/ab/cc/99/abcc9949d0419ef1f0963a54aef06397.jpg";
      } else if(window.currentReciter === 'mustafa'){
        reciterImg = "https://i.pinimg.com/564x/41/e5/5e/41e55ea6e5e5d70798320e94d447cdb7.jpg";
      } else if(window.currentReciter === 'husari'){
        reciterImg = "https://i.pinimg.com/564x/3f/da/7e/3fda7ed5056347e700cac64d07e164c3.jpg";
      }
      tilaawaDetail.innerHTML = `
        <button class="back-btn" onclick="backToSurahList()">عودة إلى قائمة السور</button>
        <div class="audio-player animate__animated animate__zoomIn">
          <p id="tilawah-title" style="font-size:18px; margin-bottom:10px;">سورة ${surah.name} - ${getReciterName(window.currentReciter)}</p>
          <img src="${reciterImg}" alt="صورة القارئ" style="width:150px; height:150px; object-fit:cover; border-radius:50%; border:5px solid var(--gold-color); box-shadow:0 0 8px rgba(0,0,0,0.2); display:block; margin:20px auto;">
          <audio id="audio-player" src="${audioSrc}" style="display:none;"></audio>
          <div class="controls">
            <button id="prev-btn"><i class="fas fa-backward"></i></button>
            <button id="play-btn"><i class="fas fa-play"></i></button>
            <button id="next-btn"><i class="fas fa-forward"></i></button>
          </div>
          <div class="progress-container">
            <span id="current-time">0:00</span>
            <input type="range" id="progress-bar" value="0" min="0" max="100" step="0.1">
            <span id="duration">0:00</span>
          </div>
        </div>
      `;
      initAudioPlayer();
    }
    function getReciterName(reciter) {
      switch(reciter) {
        case 'minshawi': return 'محمد صديق المنشاوي';
        case 'basit': return 'عبد الباسط';
        case 'yasser': return 'ياسر الدوسري';
        case 'maher': return 'ماهر المعيقلي';
        case 'mustafa': return 'مصطفى إسماعيل';
        case 'husari': return 'الحصري';
        default: return '';
      }
    }
    function initAudioPlayer() {
      const audio = document.getElementById("audio-player");
      const playBtn = document.getElementById("play-btn");
      const prevBtn = document.getElementById("prev-btn");
      const nextBtn = document.getElementById("next-btn");
      const progressBar = document.getElementById("progress-bar");
      const currentTimeElem = document.getElementById("current-time");
      const durationElem = document.getElementById("duration");
      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return mins + ":" + (secs < 10 ? "0" + secs : secs);
      }
      audio.addEventListener("loadedmetadata", () => {
        durationElem.textContent = formatTime(audio.duration);
      });
      audio.addEventListener("timeupdate", () => {
        const current = audio.currentTime;
        const dur = audio.duration;
        if(dur) {
          progressBar.value = (current / dur) * 100;
          currentTimeElem.textContent = formatTime(current);
        }
      });
      progressBar.addEventListener("input", (e) => {
        const dur = audio.duration;
        if(dur) {
          audio.currentTime = (e.target.value / 100) * dur;
        }
      });
      playBtn.addEventListener("click", () => {
        if(audio.paused) {
          audio.play();
          playBtn.innerHTML = '<i class="fas fa-pause"></i>';
        } else {
          audio.pause();
          playBtn.innerHTML = '<i class="fas fa-play"></i>';
        }
      });
      prevBtn.addEventListener("click", () => {
        if(window.currentSurahIndex > 0) {
          window.currentSurahIndex--;
          loadTilawah(window.globalSurahList[window.currentSurahIndex]);
        }
      });
      nextBtn.addEventListener("click", () => {
        if(window.currentSurahIndex < window.globalSurahList.length - 1) {
          window.currentSurahIndex++;
          loadTilawah(window.globalSurahList[window.currentSurahIndex]);
        }
      });
    }
    function backToSurahList() {
      document.getElementById('tilaawa-detail').style.display = 'none';
      document.getElementById('surah-list').style.display = 'block';
      window.scrollTo(0, 0);
    }
    function backToTilaawaList() {
      document.getElementById('surah-list').style.display = 'none';
      document.getElementById('reciters-container').style.display = 'grid';
      window.scrollTo(0, 0);
    }
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
    }
    function changeFontSize(value) {
      document.documentElement.style.setProperty('--ayah-font-size', value + 'px');
    }
    async function showPrayerTimes() {
      showLoadingOverlay();
      const today = new Date();
      const day = String(today.getDate()).padStart(2, '0');
      const month = String(today.getMonth()+1).padStart(2, '0');
      const year = today.getFullYear();
      const url = `https://api.aladhan.com/v1/timingsByCity/${day}-${month}-${year}?city=Cairo&country=Egypt&method=8`;
      const data = await fetchData(url);
      if(data?.data?.timings) {
        const timings = data.data.timings;
        document.getElementById('prayer-container').innerHTML = `
          <div class="prayer-times-grid">
            ${['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'].map(key => 
              `<div class="prayer-time animate__animated animate__fadeIn" onclick="showPrayerDetail('${prayerNameArabic[key]}', '${timings[key]}')">
                <i class="${prayerIcons[key]}"></i>
                <h3>${prayerNameArabic[key]}</h3>
                <p>${(function(time){
                  let [hour, minute] = time.split(':');
                  hour = parseInt(hour);
                  const suffix = hour >= 12 ? 'م' : 'ص';
                  hour = (hour % 12) || 12;
                  return `${hour}:${minute} ${suffix}`;
                })(timings[key])}</p>
              </div>`).join('')}
          </div>`;
      }
      hideLoadingOverlay();
    }
    function showPrayerDetail(prayerName, time) {
      Swal.fire({
        title: `تفاصيل الصلاة - ${prayerName}`,
        html: `<p style="font-size: 18px;">الوقت: ${time}</p>`,
        showConfirmButton: true,
        customClass: { popup: 'animate__animated animate__fadeInDown' }
      });
    }
    function showLoadingOverlay() {
      document.getElementById('loading-overlay').classList.remove('hidden');
    }
    function hideLoadingOverlay() {
      document.getElementById('loading-overlay').classList.add('hidden');
    }
    function showSection(sectionId, element) {
      const currentSection = document.querySelector('.section.active-section');
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      element.classList.add('active');
      if (currentSection) {
        currentSection.classList.add('animate__animated', 'animate__fadeOut');
        setTimeout(() => {
          currentSection.classList.remove('active-section', 'animate__animated', 'animate__fadeOut');
          const newSection = document.getElementById(sectionId);
          newSection.classList.add('active-section', 'animate__animated', 'animate__fadeIn');
          if(sectionId === 'quran-section') showSurahMenu();
          if(sectionId === 'prayer-section') showPrayerTimes();
          if(sectionId === 'tilaawa-section') {
            document.getElementById('reciters-container').style.display = 'grid';
            document.getElementById('surah-list').style.display = 'none';
            document.getElementById('tilaawa-detail').style.display = 'none';
          }
          if(sectionId === 'khatma-section'){
            // عند دخول قسم الخاتمة، إذا لم يكن الاسم موجودًا، اطلب من المستخدم إدخاله
            if(!userName){
              Swal.fire({
                title: 'ادخل اسمك',
                input: 'text',
                inputAttributes: { autocapitalize: 'words' },
                confirmButtonText: 'تأكيد',
                allowOutsideClick: false,
                preConfirm: (name) => {
                  if (!name.trim()) {
                    Swal.showValidationMessage('الاسم مطلوب');
                    return false;
                  }
                  return name;
                }
              }).then((result) => {
                if(result.isConfirmed){
                  userName = result.value;
                  localStorage.setItem('userName', userName);
                }
              });
            }
          }
        }, 200);
      } else {
        const newSection = document.getElementById(sectionId);
        newSection.classList.add('active-section', 'animate__animated', 'animate__fadeIn');
        if(sectionId === 'quran-section') showSurahMenu();
        if(sectionId === 'prayer-section') showPrayerTimes();
        if(sectionId === 'tilaawa-section') {
          document.getElementById('reciters-container').style.display = 'grid';
          document.getElementById('surah-list').style.display = 'none';
          document.getElementById('tilaawa-detail').style.display = 'none';
        }
        if(sectionId === 'khatma-section'){
          if(!userName){
            Swal.fire({
              title: 'ادخل اسمك',
              input: 'text',
              inputAttributes: { autocapitalize: 'words' },
              confirmButtonText: 'تأكيد',
              allowOutsideClick: false,
              preConfirm: (name) => {
                if (!name.trim()) {
                  Swal.showValidationMessage('الاسم مطلوب');
                  return false;
                }
                return name;
              }
            }).then((result) => {
              if(result.isConfirmed){
                userName = result.value;
                localStorage.setItem('userName', userName);
              }
            });
          }
        }
      }
    }
    window.onload = async () => {
      updateHijriDate();
      showSurahMenu();
      await fetchPrayerTimesGlobal();
      window.countdownInterval = setInterval(() => {
        if(window.globalPrayerTimes) {
          updateCountdown(window.globalPrayerTimes);
        }
      }, 1000);
      setTimeout(() => hideLoadingOverlay(), 2000);
    };
    window.addEventListener("scroll", function() {
      const st = window.pageYOffset || document.documentElement.scrollTop;
      document.getElementById("header").style.top = st > 60 ? "-60px" : "0";
    });
  </script>
</body>
</html>
